@namespace iPath.Blazor.Componenents.ServiceRequests

@inherits ServiceRequestViewComponentBase

@inject IDialogService srvDialog
@inject UserViewModel uvm

<div class="ipath_annotation_block">
    <div class="ipath_annotation_info">
        <strong><OwnerLink Owner="@Item.Owner" /></strong><br />
        @Item.CreatedOn.ToString("g")</div>
    <div class="ipath_annotation_text">
        @if (Item.Data?.Questionnaire is not null)
        {
            <QuestionnaireResponseView Data="Item.Data.Questionnaire" />
        }

        @((MarkupString)Item.Data.Text)

        @if (Item.Data?.Morphology is not null)
        {
            <div class="morphology_code"><b>Morphology:</b> @Item.Data.Morphology.ToDisplay()</div>
        }
        @if (vm.HasDocument(Item.DocumentId))
        {
            <div class="ipath_annotation_footer">
                <span>@T["Comment on: "]</span><MudLink OnClick=@(() => vm.SelectDocument(Item.DocumentId.Value))>@DocumentCaption</MudLink>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public AnnotationDto Item { get; set; }

    [Parameter]
    public EventCallback<AnnotationDto> OnDelete { get; set; }

    [Parameter]
    public EventCallback<AnnotationDto> OnReply { get; set; }

    private bool Hovering;
    private string Initials;

    protected override async Task OnParametersSetAsync()
    {
        if (Item != null)
        {
            Initials = (await uvm.GetProfileAsync(Item.OwnerId))?.Initials;
        }
    }

    string FullTitle()
    {
        if (Item is null) return "";
        var cType =  T[Item.Data.Type.ToString()];
        return string.Format(T["{0} by {1}"], cType, Item.Owner.Username);
    }

    string DocumentCaption => vm.SelectedRequest is not null && Item.DocumentId.HasValue ? vm.SelectedRequest.GetDocumentCaption(Item.DocumentId.Value) : "";

    protected override void OnChangedHandler()
    {
        // no need to redraw here
    }

    async Task Delete()
    {
        await OnDelete.InvokeAsync(Item);
    }

    async Task Reply()
    {
        await OnReply.InvokeAsync(Item);
    }
}
