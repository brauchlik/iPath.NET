@page "/request/{id}/slideshow"

@attribute [Authorize]

@using MudBlazor.Services
@using iPath.Application.Features.ServiceRequests
@using iPath.Blazor.Componenents.Layouts
@layout SlideshowLayout

@inherits ServiceRequestViewComponentBase
@inject IOptions<iPathClientConfig> opts

<MudSwipeArea Style="height: 100%; width: 100%; background-color: black;"
              OnSwipeEnd="OnSwipeHandler">

    @if (vm.SelectedDocument is not null)
    {
        <div class="d-flex justify-center flex-grow-1 gap-2">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowCircleLeft" Size="Size.Small" OnClick="GotoPrevious" />
            <MudIconButton Icon="@Icons.Material.Filled.ArrowCircleRight" Size="Size.Small" OnClick="GotoNext" />
            <MudIconButton Icon="@Icons.Material.Filled.Comment" Size="Size.Small" OnClick="@(() => vm.Annotate(vm.SelectedDocument))" />
            <MudIconButton Icon="@Icons.Material.Filled.CloseFullscreen" Size="Size.Small" OnClick="@(() => vm.GoUpRequestPage())" />
        </div>

        <MudPaper Class="ipath_image slideshow" Style="background-color: black;" Elevation="0" @onclick="GotoNext">
            @if (vm.SelectedDocument.IsImage)
            {
                <MudImage src="@vm.SelectedDocument.PreviewFileUrl" Class="ipath_image_slideshow" Alt="@vm.SelectedDocument.GalleryCaption" />
            }
            else if (Wsi && vm.SelectedDocument.IsWSI)
            {
                <div class="d-flex justify-center ipath_osd">
                    <iPath.OpenSeadragon.OsdViewerIFrame ImagePath=@($"/files/{vm.SelectedDocument.Id}") MaxHeight="700" />
                </div>
            }
            else
            {
                <MudIcon Size="Size.Large" Icon="@vm.SelectedDocument.FileIcon" />
            }
            <div class="mt-2">@vm.SelectedDocument.GalleryCaption.ShortenTo(80)</div>
        </MudPaper>
    }
</MudSwipeArea>

@code
{
    [Parameter]
    public string id { get; set; }

    bool Wsi => opts.Value.WsiViewerActive;
    Guid? lastId = null;

    protected override async Task OnParametersSetAsync()
    {
        if (!vm.IsRequestLoaded(id))
        {
            await vm.LoadNode(Guid.Parse(id));
        }
        if (!lastId.HasValue)
        {
            // select first images
            await SelectFirstSlide();
        }
    }

    async Task SelectFirstSlide()
    {
        if (vm.HasSlideShow)
        {
            vm.SelectDocument(vm.SelectedRequest.Documents.FirstOrDefault(n => n.IsSlide).Id);
            lastId = vm.SelectedDocument?.Id;
        }
        else
        {
            await vm.GoUpRequestPage();
        }
    }


    async Task OnSwipeHandler(SwipeEventArgs args)
    {
        if (args.SwipeDirection == SwipeDirection.RightToLeft)
        {
            await GotoNext();
        }
        else if (args.SwipeDirection == SwipeDirection.LeftToRight)
        {
            await GotoPrevious();
        }
        lastId = vm.SelectedDocument?.Id;
    }


    private async Task OnKeyDown(KeyboardEventArgs args)
    {
        var code = args.Code ?? string.Empty;

        if (code == "Space" || code == "ArrowRight")
        {
            await GotoNext();
        }
        else if (code == "ArrowLeft")
        {
            await GotoPrevious();
        }
        else if (code == "Escape")
        {
            await vm.GoUpRequestPage();
        }
        lastId = vm.SelectedDocument?.Id;
    }

    async Task GotoNext() => await vm.SelectNextSlide();
    async Task GotoPrevious() => await vm.SelectPreviousSlide();
}