@namespace iPath.Blazor.Componenents.Shared.Coding

<MudTreeView T="CodeDisplay" Items="@TreeItems" @ref="_treeView"
             SelectionMode="SelectionMode.MultiSelection"
             FilterFunc="MatchesName"
             CheckBoxColor="Color.Info"
             Hover="true" Dense="true" Color="Color.Tertiary">
    <ItemTemplate>
        <MudTreeViewItem T="CodeDisplay" Items="@context.Children"
                         @bind-Expanded="@context.Expanded"
                         @bind-Selected="@context.Selected"
                         @bind-Selected:after="OnChange"
                         Value="@context.Value"
                         Text="@context.Value.ToDisplay()" />
    </ItemTemplate>
</MudTreeView>

@code {
    [Parameter]
    public List<TreeItemData<CodeDisplay>> TreeItems { get; set; } = [];

    [Parameter]
    public EventCallback SelectionChanged { get; set; }


    MudTreeView<CodeDisplay> _treeView;
    string _searchPhrase;

    public async Task Search(string searchPhrase)
    {
        _searchPhrase = searchPhrase;
        await _treeView.FilterAsync();
    }

    private Task<bool> MatchesName(ITreeItemData<CodeDisplay> item)
    {
        if (string.IsNullOrEmpty(item.Text))
        {
            return Task.FromResult(false);
        }

        return Task.FromResult(item.Text.Contains(_searchPhrase, StringComparison.OrdinalIgnoreCase));
    }

    async Task OnChange()
    {
        await SelectionChanged.InvokeAsync();
    }
}
