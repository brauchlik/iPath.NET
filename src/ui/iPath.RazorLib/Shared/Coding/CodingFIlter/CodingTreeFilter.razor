@namespace iPath.Blazor.Componenents.Shared.Coding

<MudTreeView T="CodeDisplay" Items="@TreeItems" @ref="_treeView"
             SelectionMode="SelectionMode.MultiSelection"
             AutoSelectParent="true"
             FilterFunc="MatchesName"
             CheckBoxColor="Color.Info"
             Hover="true" Dense="true" Color="Color.Tertiary">
    <ItemTemplate>
        <MudTreeViewItem T="CodeDisplay" Items="@context.Children"
                         @bind-Expanded="@context.Expanded"
                         Value="@context.Value" Text="@context.Value.ToDisplay()" />
    </ItemTemplate>
</MudTreeView>

@code {
    [Parameter]
    public List<TreeItemData<CodeDisplay>> TreeItems { get; set; } = [];

    [Parameter]
    public IReadOnlyCollection<CodeDisplay>? SelectedValues {
        get => _treeView?.SelectedValues;
        set
        {
            if (_treeView is not null) { _treeView.SelectedValues = value; }
        }
    }

    [Parameter]
    public EventCallback<IReadOnlyCollection<CodeDisplay>?> SelectedValuesChanged 
    {
        get => _treeView.SelectedValuesChanged;
        set
        {
            if (_treeView is not null) { _treeView.SelectedValuesChanged = value; }
        }
    }

    private async Task OnValueChanged()
    {
        await SelectedValuesChanged.InvokeAsync(SelectedValues);
    }

    MudTreeView<CodeDisplay> _treeView;
    string _searchPhrase;

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        return base.OnAfterRenderAsync(firstRender);
    }

    public async Task Search(string searchPhrase)
    {
        _searchPhrase = searchPhrase;
        await _treeView.FilterAsync();
    }

    private Task<bool> MatchesName(ITreeItemData<CodeDisplay> item)
    {
        if (string.IsNullOrEmpty(item.Text))
        {
            return Task.FromResult(false);
        }

        return Task.FromResult(item.Text.Contains(_searchPhrase, StringComparison.OrdinalIgnoreCase));
    }
}
