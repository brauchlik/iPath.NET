@page "/wsi/{id}"
@using Microsoft.Extensions.Configuration
@using iPath.Blazor.Componenents.Layouts

@attribute [ExcludeFromInteractiveRouting]

@layout WsiLayout
@inject IConfiguration config

<div id="osd" style="width: 1000px; height: 700px; background-color: black;"></div>

<div style="margin: 1em; color: white;">
    WSI viewer using <a href="https://openseadragon.github.io/">OpenSeadragon</a>
    <!--
    <string>Image: </string> <a href="@url">@url</a>
    -->
</div>


<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
        // alert("@url");
        if ("@url".length > 10)
        {
            // svs.loadImage('osd', "@url");
            loadImage('osd', "@url");
        }
    });

    async function loadImage(elemId, url)
    {
        var elem = document.getElementById(elemId);

        elem.innerHTML = ""

        var tileSources = await OpenSeadragon.GeoTIFFTileSource.getAllTileSources(url, { logLatency: false, cache: true, slideOnly: true });
        var dim = tileSources[0].dimensions;

        var osd = OpenSeadragon({
            id: elem.id,
            visibilityRatio: 1,
            minZoomImageRatio: 1,
            ajaxWithCredentials: true,
            prefixUrl: "_content/iPath.OpenSeadragon/images/",
            imageLoaderLimit: 5,
            timeout: 1000 * 1000,
            crossOriginPolicy: "Anonymous",
        });

        osd.open(tileSources);
    }
</script>


@code {
    [Parameter]
    public string id { get; set; }

    string errorMessage;

    string url => Guid.TryParse(id, out var nid) ? $"files/{nid}" : "";
    
    string url_api => Guid.TryParse(id, out var nid) ? $"/api/v1/nodes/files{nid}" : "";
}